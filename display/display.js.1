/* --- display/display.js --- */

// --- VIRTUAL CONSOLE FOR TABLET ---
function debugLog(msg, isError = false) {
    const logDiv = document.getElementById('loading');
    if (logDiv) {
        const span = document.createElement('div');
        span.style.color = isError ? '#ff4444' : '#2ecc71';
        span.style.fontSize = '13px';
        span.style.marginTop = '5px';
        span.innerText = `> ${msg}`;
        logDiv.appendChild(span);
    }
    console.log(msg);
}

let pokemonData = null;
let cellStates = {}; 

// Handles the grid layout based on screen width
const updateGrid = () => {
    let cols = window.innerWidth < 601 ? 3 : (window.innerWidth > 1024 ? 7 : 5);
    document.documentElement.style.setProperty('--cells-for-screen', cols);
    return cols;
};
let cellsForScreen = updateGrid();
window.addEventListener('resize', () => { cellsForScreen = updateGrid(); });

// Prepend server origin to relative image paths
const fixImagePath = (path) => {
    if (!path) return '';
    if (path.startsWith('http')) return path;
    return window.location.origin + path;
};

// --- INITIALIZATION ---
debugLog("Starting initialization...");

// 1. Fetch the master pokemon list (one folder up)
fetch('../pokemon.json')
    .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}: pokemon.json not found`);
        return r.json();
    })
    .then(data => {
        pokemonData = data;
        debugLog("✔ Master list loaded");
        loadSharedData();
    })
    .catch(err => {
        debugLog(`CRITICAL ERROR: ${err.message}`, true);
    });

// 2. Fetch the specific share record from Firebase
async function loadSharedData() {
    const urlParams = new URLSearchParams(window.location.search);
    const shareId = urlParams.get('s');
    
    if (!shareId) {
        debugLog("ERROR: No ID found in URL", true);
        return;
    }
    debugLog(`Searching for ID: ${shareId}...`);

    if (!window.fs || !window.db) {
        debugLog("Waiting for Firebase connection...");
        setTimeout(loadSharedData, 500);
        return;
    }

    try {
        const docRef = window.fs.doc(window.db, "shares", shareId);
        const docSnap = await window.fs.getDoc(docRef);
        
        if (docSnap.exists()) {
            debugLog("✔ Record found in database");
            const docData = docSnap.data();
            let compressed = docData.data || "";

            // Fallback for older links saved via longUrl
            if (!compressed && docData.longUrl) {
                debugLog("Legacy format detected; extracting data...");
                const urlParts = docData.longUrl.split('data=');
                if (urlParts.length > 1) {
                    compressed = urlParts[1];
                }
            }

            if (!compressed) throw new Error("No data string found in record.");

            // Decompress using LZString
            const decompressed = LZString.decompressFromEncodedURIComponent(compressed);
            if (!decompressed) throw new Error("Decompression failed");

            cellStates = JSON.parse(decompressed);
            
            // --- UPDATE SUBTITLE ---
            // Detect Tab (Prefix) and Color from data/record
            const firstKey = Object.keys(cellStates)[0] || "";
            const category = firstKey.split('-')[0] || "Collection";
            const colorName = docData.color || "Selected";
            
            const subtitle = document.getElementById('status-subtitle');
            if (subtitle) {
                subtitle.innerText = `${category.toUpperCase()} - ${colorName.charAt(0).toUpperCase() + colorName.slice(1)} Filter`;
            }

            debugLog(`✔ Decoded ${Object.keys(cellStates).length} Pokémon states`);
            
            // Success! Hide loader and render
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                initSearch();
                renderSharedContent();
            }, 800);
            
        } else {
            debugLog("ERROR: Share ID does not exist", true);
            if(document.getElementById('status-subtitle')) {
                document.getElementById('status-subtitle').innerText = "Link Expired";
            }
        }
    } catch (e) {
        debugLog(`CRITICAL ERROR: ${e.message}`, true);
        console.error(e);
    }
}

// 3. Search functionality
function initSearch() {
    const input = document.getElementById('searchInput');
    if (!input) return;
    input.oninput = () => {
        const query = input.value.toLowerCase().trim();
        document.querySelectorAll('td').forEach(td => {
            td.style.display = td.innerText.toLowerCase().includes(query) ? "" : "none";
        });
    };
}

// 4. Render the UI
function renderSharedContent() {
    const content = document.getElementById('content');
    if(!content || !pokemonData) return;
    
    content.innerHTML = '';
    const generations = {};
    
    // Group pokemon by generation number
    pokemonData.pokemon.forEach(p => {
        if (!generations[p.generation_number]) generations[p.generation_number] = [];
        generations[p.generation_number].push(p);
    });

    // Determine the category prefix (shiny, xxl, etc) for this share
    const firstKey = Object.keys(cellStates)[0] || "";
    const prefix = firstKey.split('-')[0] || 'shiny';

    Object.keys(generations).sort((a,b)=>a-b).forEach(num => {
        const pks = generations[num];
        const table = document.createElement('table');
        let row = table.insertRow();
        let cellCount = 0;

        pks.forEach(p => {
            p.forms.forEach(f => {
                let state = null;
                const isShinyTab = prefix === 'shiny';

                // SMART FILTER LOGIC
                // 1. Check for specific form key (f.key) - the new clean way
                if (cellStates[`${prefix}-${f.key}`]) {
                    state = cellStates[`${prefix}-${f.key}`];
                } 
                // 2. Fallback to ID key (p.id) ONLY for Normal forms - fixes Vivaldi legacy bugs
                else if (f.form === 'normal' && cellStates[`${prefix}-${p.id}`]) {
                    state = cellStates[`${prefix}-${p.id}`];
                }

                if (state) {
                    if (cellCount > 0 && cellCount % cellsForScreen === 0) row = table.insertRow();
                    
                    const cell = row.insertCell();
                    cell.className = state;
                    
                    const img = isShinyTab ? f.shiny.image : f.normal.image;
                    
                    cell.innerHTML = `
                        <div class="pokemon-number">#${p.id}</div>
                        <img class="pokemon-image" src="${fixImagePath(img)}" loading="lazy">
                        <div class="pokemon-name">${p.name}</div>
                        <div class="pokemon-form">${f.form === 'normal' ? '' : f.form}</div>
                    `;
                    cellCount++;
                }
            });
        });
        
        if (cellCount > 0) {
            const h2 = document.createElement('h2');
            h2.innerText = `Gen ${num}`;
            h2.style.marginTop = "25px";
            content.appendChild(h2);
            content.appendChild(table);
        }
    });

    if (content.innerHTML === '') {
        content.innerHTML = '<div style="padding:50px;">This shared view is empty or uses an invalid format.</div>';
    }
}
